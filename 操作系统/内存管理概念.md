# 内存管理概念

## 1 内存管理的基本原理和要求

程序执行前需要先放到内存中才能被CPU处理——缓和CPU和硬盘之间的速度矛盾

### 1.1 内存管理的功能

1. 内存空间的分配与回收

   操作系统完成主存储器空间的分配和管理

2. 地址转换

   逻辑地址转换为物理地址

3. 内存空间的扩充

   利用虚拟存储技术或者自动自动覆盖技术，从逻辑上扩充内存

4. 存储保护

   保护各道作业在各自存储空间运行，互不干扰

### 1.2 程序的装入和链接

1. 创建步骤

   1. 编译：编译程序将用户源代码编译成若干目标模块
   2. 链接：由链接程序将编译后形成的一组目标模块及所需要的库函数链接在一起，形成一个完整的模块
   3. 装入：由装入程序将装入模块装入内存运行

2. 链接类型

   1. 静态链接：程序运行之前，将库函数链接一个完整的可执行程序
   2. 装入时动态链接：将用户源程序编译后得到目标模块，装入内存时，采用边装入边链接的方式
   3. 运行时动态链接：对于某些目标模块的链接，程序需要时才会对其链接（便于修改和更新，便于实现对目标模块的共享）

3. 装入模式

   1. 绝对装入

      (1) 装入时按照实际的内存地址，将程序和数据装入内存。

      (2) 优点：不需要对程序和数据的地址经行修改。

      (3) 缺点：只适用于单道程序环境。

   2. 可重定位装入（静态重定位）

      (1) 此时采用的是模块与模块的相对地址，然后将程序和数据装入内存。

      (2) 装入时对目标程序中指令和数据的修改称为重定位，地址变换通常是在装入时一次完成的，又被称为静态重定位。

      (3) 特点：对作业的装入必须要一次全部装入，并且运行中作业不能再内存中移动，也不能申请空间。

   3. 动态运行时装入（动态重定位）

      (1) 装入程序把装入模块装入内存后，并不把装入模块中的相对地址转换为绝对地址，当程序真正执行时才进行转换。

      (2) 特点：需要重定位寄存器；可以将程序分配到不连续的存储区中；便于程序段的共享；可以向用户提供更大的地址空间（地址空间大于存储空间）。

### 1.3 逻辑地址空间和物理地址空间

1. 逻辑地址空间

   即相对地址，链接程序依次按照各个模块的相对地址构成的统一的从0号单元开始编址的逻辑地址空间。

2. 物理逻辑空间

   (1) 内存中物理单元的集合，是地址转换的最终地址，进程在运行时执行指令和访问数据，最后都要通过物理地址从主存中存取。

   (2) 地址重定位：逻辑地址转换成物理地址的过程。

### 1.4 内存保护

​	(1) CPU中设置上、下寄存器，存放用户作业在主存中的下限和上限地址，每当CPU要访问一个地址时，分别和两个寄存器的数据比较，判断是否越界。

​	(2) 重定位寄存器（基址寄存器）和界地址寄存器（限长寄存器）：重定位寄存器中包含最小的物理地址值，界地址寄存器包含逻辑地址的最大值

​	地址转换过程：逻辑地址->界地址寄存器->重定位寄存器->物理地址

## 2 覆盖与交换

### 2.1 覆盖

1. 思想：将程序分为多个段（多个模块），常用的段常驻内存，不常用的段在需要时调入内存。
2. 将用户空间分为一个固定区和若干覆盖区，活跃部分放在固定区，即将访问的段放在覆盖区。
3. 特点：打破了必须将一个进程的全部信息装入主存后才能运行的限制，内存中能够更新的地方只有覆盖区的段，不覆盖区的段会常驻内存

### 2.2 交换

1. 思想：内存空间紧张时，系统将内存中的某些进程暂时换出外存，把外存中某些已具备运行条件的进程换入内存（进程在内存与磁盘间动态调度）。
2. 换出：把处于等待状态的程序重内存中转移到辅存。
3. 换入：把准备好竞争CPU运行的程序从辅存转移到内存。
4. 结构：把磁盘空间分为文件区和对换区两部分
   1. 文件区主要用于存放文件，主要追求存储空间的利用率，因此对文件空间的管理采用离散分配方式。
   2. 对换区空间只占磁盘空间的一部分，被换出的进程数据就存放在对换区，主要追求换入换出速度，因此通常对换区采用连续分配方式

### 2.3 交换存在的问题

1. 备份存储，使用快速硬盘，要求存储空间足够大，并且能够对内存映像进行直接访问。
2. 转移时间和所交换的内存空间成正比。
3. 只有进程空闲状态才能将进程换出。
4. 交换空间通常作为磁盘的一整块，且独立于文件系统，因此使用起来会很快。
5. 交换通常在有许多进程运行且内存吃紧时开始启动，系统负荷降低就停止。
6. 普通的交换使用不多，但交换策略的某些变体在许多系统中仍发挥作用。

注意：PCB会常驻内存，不会被换出外存。